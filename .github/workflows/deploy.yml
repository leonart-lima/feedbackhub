name: Deploy Azure Functions

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_FUNCTIONAPP_NAME: 'feedbackhub-functions'
  AZURE_FUNCTIONAPP_PACKAGE_PATH: '.'
  JAVA_VERSION: '17'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: 'Checkout GitHub Action'
      uses: actions/checkout@v3

    - name: 'Setup Java'
      uses: actions/setup-java@v3
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: 'maven'

    - name: 'Build with Maven'
      run: mvn clean package -DskipTests

    - name: 'Run Tests'
      run: mvn test

    - name: 'Run Azure Functions Action'
      uses: Azure/functions-action@v1
      with:
        app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
        package: '${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}/target/azure-functions/feedbackhub'
        publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}

    - name: 'Sync App Settings'
      uses: azure/appservice-settings@v1
      with:
        app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
        mask-inputs: false
        app-settings-json: |
          [
            {
              "name": "DB_URL",
              "value": "${{ secrets.DB_URL }}",
              "slotSetting": false
            },
            {
              "name": "DB_USERNAME",
              "value": "${{ secrets.DB_USERNAME }}",
              "slotSetting": false
            },
            {
              "name": "DB_PASSWORD",
              "value": "${{ secrets.DB_PASSWORD }}",
              "slotSetting": true
            },
            {
              "name": "AZURE_STORAGE_CONNECTION_STRING",
              "value": "${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}",
              "slotSetting": true
            },
            {
              "name": "SENDGRID_API_KEY",
              "value": "${{ secrets.SENDGRID_API_KEY }}",
              "slotSetting": true
            },
            {
              "name": "ADMIN_EMAILS",
              "value": "${{ secrets.ADMIN_EMAILS }}",
              "slotSetting": false
            },
            {
              "name": "REPORT_EMAILS",
              "value": "${{ secrets.REPORT_EMAILS }}",
              "slotSetting": false
            }
          ]

